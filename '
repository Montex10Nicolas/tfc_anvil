import { command, form, query } from "$app/server";
import { db } from "$lib/server/db";
import { AlloyDB, inputItemDB, itemDB, metalGroupsDB, worldDB } from "$lib/server/db/schema";
import { asc, eq } from "drizzle-orm";
import z from "zod";

export const getWorlds = query(async () => {
  const worlds = await db.select().from(worldDB);
  return worlds;
});

export const getMetals = query(async () => {
  const metalsGroup = await db.select().from(metalGroupsDB).orderBy(asc(metalGroupsDB.name));
  return metalsGroup;
});

export const allItems = query(async () => {
  const items = await db.select().from(itemDB);
  return items;
});

export const createWorld = form((z.object({ name: z.string().min(1) })),
  async ({ name }) => {
    await db.insert(worldDB).values({ name: name });
    getWorlds().refresh();
  });

export const createMetal = form((z.object({ name: z.string().min(1) })),
  async ({ name }) => {
    await db.insert(metalGroupsDB).values({ name: name });
    getMetals().refresh();
  });

export const createItem = command((z.object({ name: z.string().min(1), metalID: z.string(), worldID: z.string(), itemInput: z.string(), path: z.array(z.number()) })),
  async ({ name, worldID, metalID, itemInput, path }) => {
    await db.insert(itemDB).values({ name: name, world_id: worldID, metal_id: metalID, inputItemName: itemInput, path: path });
  });

export const removeItem = command((z.string()), async (itemID) => {
  await db.delete(itemDB).where(eq(itemDB.id, itemID))
});

export const getInputItems = query(async () => {
  const inputItems = await db.select().from(inputItemDB);
  return inputItems;
})

export const updateItem = command((z.object({ id: z.string(), name: z.string(), path: z.array(z.number()), inputItem: z.string() })),
  async ({ id, name, path, inputItem }) => {
    await db.update(itemDB).set({
      name: name,
      path: path,
      inputItemName: inputItem
    }).where(eq(itemDB.id, id));
  });

export const getAlloys = query(async () => {
  return await db.select().from(AlloyDB);
})

const alloyIngZod = z.object({
  fluidName: z.string(),
  min: z.number().min(1),
  max: z.number().min(1)
})

export const createAlloy = command((z.object({
  name: z.string(),
  ingredients: z.array(alloyIngZod).min(2)
})),
  async ({ name, ingredients }) => {
    console.log(name)
    console.table(ingredients)
  });
